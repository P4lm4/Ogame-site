<!DOCTYPE html>
<html>
    <head>
        <title>Ogame</title>

        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

        <link rel="stylesheet" href="style/general.css">
        <link rel="stylesheet" href="style/headers.css">
        <link rel="stylesheet" href="style/sidebar.css">
        <link rel="stylesheet" href="style/info.css">
        <link rel="stylesheet" href="style/iframe.css">
        <link rel="stylesheet" href="style/info.css">
        <link rel="stylesheet" href="style/info-other-main.css">

    </head>
    <body>
        <div class="header">
            <div class="left-section"></div>
            <div class="middle-section">
                <div class="header-resource-icon">
                    <img class="iron-icon" src="headers-pictures/iron-spin.gif">
                    <div id="iron">-</div>
                </div>
                <div class="header-resource-icon">
                    <img class="crystal-icon" src="headers-pictures/crystalG.gif">
                    <div id="crystal">-</div>
                </div>
                <div class="header-resource-icon">
                    <img class="energy-icon" src="headers-pictures/energy-spin.gif">
                    <div id="energy">-</div>
                </div>
            </div>
            <div class="right-section">
                <div class="header-avatar-image">
                    <div class="header-avatar-image-signout">
                        <a id="username" href="#" style="color: white; text-decoration: none;">-</a>
                        <a href="#" onclick="signOut()" style="color: white; text-decoration: none;">Sign out</a>
                    </div>
                    <img class="avatar-image" src="avatar-pictures/Avatar-pictures.png">
                </div>
            </div>
        </div>

        <div class="sidebar-left">
            <button id="b1" class="sidebar-button" onclick="changeTab('overview')">Overview</button>
            <button id="b2" class="sidebar-button" onclick="changeTab('resource')">Resource</button>
            <button id="b3" class="sidebar-button" onclick="changeTab('shipyard')">Shipyard</button>
            <button id="b4" class="sidebar-button" onclick="changeTab('fleet')">Fleet</button>
        </div>

        <div id="ownedPlanet" class="sidebar-right">
            <!--<button id="planetBtn" class="sidebar-link">
                <img class="planet-icon" src="headers-pictures/Planeta1.png">
                <div id="nameOfPlanet">-</div>
                <div id="coordinationOfPlanet">-</div>
            </button> -->
        </div>
        
        <div id="tabContainer" class="iframe-container">
            
        </div>


    </body>
    <script>

        var tabContainer = document.getElementById("tabContainer");






        async function changeTab(tabName) 
        {
            const response = await fetch(`http://${window.location.hostname}:5500/${tabName}.html`);
            var data = await response.text();

            tabContainer.innerHTML = data;

            reloadResource();
            infoConShip();
            infoUpgradeBuilding();

        }

        changeTab("overview");

        async function request(endPoint, args)
        {
            var url = `http://${window.location.hostname}:8080/${endPoint}?token=${localStorage.getItem("OG.token")}`;
            for (var key in args)
            {
                if(args.hasOwnProperty(key))
                {
                    url += `&${key}=${encodeURIComponent(args[key])}`;
                }
            }

            const response = await fetch(url);

            if(response.ok)
            {
                var data = await response.json();
                return data;
            }
            else
            {
                return{success:false};
            }

           
        }

        async function upgradeBuilding(upgradeId)
        {
            /*const response = await fetch(`http://127.0.0.1:8080/updateBuilding?token=${localStorage.getItem("OG.token")}&idPlanet=${localStorage.getItem("OG.selectedPlanet")}&idBuilding=${idBuilding}`);
            var data = await response.json();*/

            var data = await request("updateBuilding", {
                idPlanet: localStorage.getItem("OG.selectedPlanet"), 
                idBuilding: upgradeId
            });


            if(data.success)
            {
                alert("Zgrada uspijesno unapredjena! ");
            }
            else
            {
                alert("Zgrada nije unapredjena! ");
            }

            reloadResource();
            infoUpgradeBuilding();
            infoConShip();
            
        }
        
        async function infoUpgradeBuilding()
        {
            var pictureBuilding = document.getElementById("pictureUpBuilding");
            var nameBuilding = document.getElementById("nameUpBuilding");
            var lvlBuilding = document.getElementById("lvlUpBuilding");
            var timeLeftBuilding = document.getElementById("timeLeftUpBuilding");

            /*const response = await fetch(`http://127.0.0.1:8080/updateBuildingInfo?token=${localStorage.getItem("OG.token")}&idPlanet=${localStorage.getItem("OG.selectedPlanet")}`);
            var data = await response.json();*/

            var data = await request("updateBuildingInfo", {idPlanet: localStorage.getItem("OG.selectedPlanet")});

            if(data.success && data.isConstructingBuilding)
            {
                pictureBuilding.src = "channel-pictures/" + data.id + ".png";
                nameBuilding.innerText = data.name;

                if(data.buildingLvl < 0)
                {
                    lvlBuilding.innerText = "Constructing level " + (data.buildingLvl + 2);
                }
                else
                {
                    lvlBuilding.innerText = "Upgrading level " + (data.buildingLvl + 1) + " to Level " + (data.buildingLvl + 2);
                }

                timeLeftBuilding.innerText = "Time left: " +  new Date(data.conTime * 1000).toISOString().slice(11, 19);
            }
            else
            {
                pictureBuilding.src = "";
                nameBuilding.innerText = "-";
                lvlBuilding.innerText = "-";
                timeLeftBuilding.innerText = "-";
            }

        }




        async function buildShip(buildShipId)
        {
            var inputField = document.getElementById(buildShipId + "-input");


            var shipCount = inputField.value;


            /*const response = await fetch(`http://127.0.0.1:8080/buildShip?token=${localStorage.getItem("OG.token")}&idPlanet=${localStorage.getItem("OG.selectedPlanet")}&idShip=${idShip}&count=${count}`);
            var data = await response.json();*/

            var data = await request("buildShip", {idPlanet:localStorage.getItem("OG.selectedPlanet"), idShip:buildShipId, count:shipCount});

            if(data.success)
            {
                alert("Brodovi pocinju da se prave! ")
            }
            else
            {
                alert("Doslo je do greske! " + data.status)
                
            }

            infoConShip();
            reloadResource();
            infoUpgradeBuilding();

        }

        async function infoConShip()
        {
            var nameShip = document.getElementById("nameConShip");
            var countConShip = document.getElementById("countConShip");
            var timeConShip = document.getElementById("timeConShip");
            var fullTimeConShip = document.getElementById("fullTimeConShip");
            var pictureShip = document.getElementById("pictureConShip");

            /*const respons = await fetch(`http://127.0.0.1:8080/buildShipInfo?token=${localStorage.getItem("OG.token")}&idPlanet=${localStorage.getItem("OG.selectedPlanet")}`)
            var data = await respons.json();*/

            var data = await request("buildShipInfo", {idPlanet:localStorage.getItem("OG.selectedPlanet")});

            if(data.success && data.isConstructionShip)
            {
                pictureShip.src = "channel-pictures/" + data.id + ".png"
                nameShip.innerText = data.name;
                countConShip.innerText = data.countShips;
                timeConShip.innerText = "Time left: " +  new Date(data.conTime * 1000).toISOString().slice(11, 19);
                fullTimeConShip.innerText = "Time left: " +  new Date(data.fullConTime * 1000).toISOString().slice(11, 19);
            }
            else
            {
                pictureShip.src = "";
                nameShip.innerText = "-";
                countConShip.innerText = "-";
                timeConShip.innerText = "-";
                fullTimeConShip.innerText = "-";
            }

        }
        


        var usernameLabel = document.getElementById("username");
        usernameLabel.innerHTML = localStorage.getItem("OG.username");
        

        async function reloadResource()
        {
            var iron = document.getElementById("iron");
            var crystal = document.getElementById("crystal");
            var energy = document.getElementById("energy");
            

            /*const response = await fetch(`http://127.0.0.1:8080/resource?token=${localStorage.getItem("OG.token")}&idPlanet=${localStorage.getItem("OG.selectedPlanet")}`);
            var data = await response.json();*/

            var data = await request("resource", {idPlanet:localStorage.getItem("OG.selectedPlanet")});

            if(data.success)
            {
                iron.innerHTML = data.iron;
                crystal.innerHTML = data.crystal;
                energy.innerHTML = data.energyConsumption + " / " + data.energyProduction;
            }
            else
            {
                alert("Neuspijesno ucitani resursi! ");
            }
        }

        async function listOfOwnedPlanets()
        {

            var planetContainer = document.getElementById("ownedPlanet");

            /*const respons = await fetch(`http://127.0.0.1:8080/planets?token=${localStorage.getItem("OG.token")}`);
            var data = await respons.json();*/

            var data = await request("planets", {});

            if(data.success)
            {

                planetContainer.innerHTML = "";

                for(var i = 0; i < data.ownedPlanets.length; i++)
                {
                    var planetButton = document.createElement("button");
                    planetButton.id = i;
                    planetButton.onclick = function() { changePlanet(this.id); };
                    planetButton.className = "sidebar-link";

                    planetContainer.appendChild(planetButton);

                    var planetImg = document.createElement("img");
                    planetImg.className = "planet-icon";
                    planetImg.src = "headers-pictures/Planet" + ((data.ownedPlanets[i].id % 6) + 1) + ".png";

                    planetButton.appendChild(planetImg);

                    var planetName = document.createElement("div");
                    planetName.id = "nameOfPlanet";
                    planetName.innerHTML = data.ownedPlanets[i].name;

                    planetButton.appendChild(planetName);

                    var planetCoordinates = document.createElement("div");
                    planetCoordinates.id = "coordinationOfPlanet";
                    planetCoordinates.innerHTML = data.ownedPlanets[i].positionX + " / " + data.ownedPlanets[i].positionY;

                    planetButton.appendChild(planetCoordinates);
                }
                
            }
        }

        async function changePlanet(i)
        {
            var planets = JSON.parse(localStorage.getItem("OG.planets"));

            localStorage.setItem("OG.selectedPlanet", planets[i]);

            infoConShip();
            reloadResource();
            infoUpgradeBuilding();

        }

        async function signOut()
        {

            /*const respons = await fetch(`http://127.0.0.1:8080/signOut?token=${localStorage.getItem("OG.token")}`);
            var data = await respons.json();*/

            var data = await request("signOut", {});

            if(data.success)
            {
                localStorage.clear();
                alert("Uspijesno ste izlogovani! ");
                location.href = `http://${window.location.hostname}:5500/login.html`;
            }
            else
            {
                alert("Niste se uspijeli izlogovati! ");
            }

        }

        reloadResource();

        listOfOwnedPlanets();

    </script>
</html>